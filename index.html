<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Native AES-GCM Messenger</title>
    <style>
        :root { --main: #00ff9d; --bg: #1a1a1a; --panel: #2d2d2d; }
        body { font-family: monospace; background: var(--bg); color: #ccc; padding: 20px; max-width: 650px; margin: 0 auto; }
        .box { background: var(--panel); border: 1px solid #444; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        h2 { margin-top: 0; color: var(--main); border-bottom: 1px solid #444; padding-bottom: 10px; }
        
        textarea { width: 100%; height: 80px; background: #000; color: var(--main); border: 1px solid #555; padding: 10px; box-sizing: border-box; resize: vertical; }
        
        button { background: var(--main); color: #000; border: none; padding: 12px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 5px; font-family: monospace; font-size: 14px; }
        button:hover { opacity: 0.9; }
        button.secondary { background: #555; color: #fff; }
        
        .status-bar { margin-bottom: 10px; font-size: 12px; }
        .active { color: var(--main); font-weight: bold; }
        .inactive { color: #ff5555; }
        
        .file-upload { border: 1px dashed #666; padding: 10px; text-align: center; cursor: pointer; margin-bottom: 10px; display: block; }
        input[type="file"] { display: none; }
    </style>
</head>
<body>

    <!-- KEY MANAGEMENT -->
    <div class="box">
        <h2>1. Key Configuration</h2>
        <div class="status-bar">
            STATUS: <span id="keyStatus" class="inactive">NO KEY LOADED</span>
        </div>

        <!-- Import -->
        <label class="file-upload">
            Click to Load 'secret.key' file
            <input type="file" id="keyFile" accept=".json" onchange="importKeyFile()">
        </label>

        <!-- Generate -->
        <button class="secondary" onclick="generateAndSaveKey()">Generate New Key (For you & friends)</button>
    </div>

    <!-- MESSAGING -->
    <div class="box">
        <h2>2. Message Enigma</h2>
        <textarea id="input" placeholder="Type plain text to encrypt... OR paste code to decrypt..."></textarea>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top:10px;">
            <button onclick="doEncrypt()">ENCRYPT (GCM)</button>
            <button class="secondary" onclick="doDecrypt()">DECRYPT</button>
        </div>

        <p>Output:</p>
        <textarea id="output" readonly style="color: #fff; border-color: #666;"></textarea>
        <button class="secondary" onclick="copyOutput()">Copy Output</button>
    </div>

    <script>
        let APP_KEY = null; // Stores the CryptoKey object

        // --- UTILS: Buffers to Base64 and back ---
        const buffToB64 = (buf) => btoa(String.fromCharCode(...new Uint8Array(buf)));
        const b64ToBuff = (b64) => Uint8Array.from(atob(b64), c => c.charCodeAt(0));

        // --- 1. KEY GENERATION & EXPORT ---
        async function generateAndSaveKey() {
            // Generate a random AES-GCM Key (256 bit is standard)
            APP_KEY = await window.crypto.subtle.generateKey(
                { name: "AES-GCM", length: 256 },
                true, // extractable
                ["encrypt", "decrypt"]
            );

            // Export to JSON to save as file
            const exported = await window.crypto.subtle.exportKey("jwk", APP_KEY);
            const blob = new Blob([JSON.stringify(exported)], {type: "application/json"});
            
            // Trigger Download
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = "secret.key.json";
            a.click();

            updateStatus(true);
        }

        // --- 2. KEY IMPORT ---
        async function importKeyFile() {
            const file = document.getElementById('keyFile').files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const jwk = JSON.parse(e.target.result);
                    // Import JSON back to CryptoKey
                    APP_KEY = await window.crypto.subtle.importKey(
                        "jwk", jwk,
                        { name: "AES-GCM" },
                        true,
                        ["encrypt", "decrypt"]
                    );
                    updateStatus(true);
                } catch(err) {
                    alert("Invalid Key File!");
                    console.error(err);
                }
            };
            reader.readAsText(file);
        }

        // --- 3. ENCRYPT (AES-GCM) ---
        async function doEncrypt() {
            if (!APP_KEY) return alert("Load a key first!");
            const text = document.getElementById('input').value;
            const encoded = new TextEncoder().encode(text);

            // GCM requires a unique IV (Nonce) for every message.
            // We generate 12 random bytes.
            const iv = window.crypto.getRandomValues(new Uint8Array(12));

            const ciphertext = await window.crypto.subtle.encrypt(
                { name: "AES-GCM", iv: iv },
                APP_KEY,
                encoded
            );

            // Pack IV + Ciphertext together so we can decrypt later
            // Format: [IV (12 bytes)] + [Ciphertext]
            const combined = new Uint8Array(iv.length + ciphertext.byteLength);
            combined.set(iv);
            combined.set(new Uint8Array(ciphertext), iv.length);

            document.getElementById('output').value = buffToB64(combined);
        }

        // --- 4. DECRYPT (AES-GCM) ---
        async function doDecrypt() {
            if (!APP_KEY) return alert("Load a key first!");
            try {
                const rawString = document.getElementById('input').value;
                const combined = b64ToBuff(rawString);

                // Extract IV (first 12 bytes) and Ciphertext (rest)
                const iv = combined.slice(0, 12);
                const data = combined.slice(12);

                const decrypted = await window.crypto.subtle.decrypt(
                    { name: "AES-GCM", iv: iv },
                    APP_KEY,
                    data
                );

                document.getElementById('output').value = new TextDecoder().decode(decrypted);
            } catch (e) {
                document.getElementById('output').value = "⚠️ DECRYPTION FAILED. Wrong Key or Corrupt Text.";
            }
        }

        function updateStatus(active) {
            const el = document.getElementById('keyStatus');
            if (active) {
                el.innerText = "SECURE LINK ESTABLISHED";
                el.className = "active";
            }
        }

        function copyOutput() {
            const copyText = document.getElementById("output");
            copyText.select();
            document.execCommand("copy");
        }
    </script>
</body>
</html>
